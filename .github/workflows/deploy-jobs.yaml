name: Reusable Docker Build & K8s Update

on:
  workflow_call:
    inputs:
      dockerhub-username:
        required: true
        type: string
        description: "DockerHub username for image tagging"
      service-name:
        required: true
        type: string
        description: "The name of the service (e.g. expenses, mailer) used for image names"
      manifest-file:
        required: true
        type: string
        description: "The k8s manifest filename to update (e.g. mailer.yaml)"
    secrets:
      DOCKERHUB_TOKEN:
        required: true
      PERSONAL_ACCESS_TOKEN:
        required: true

jobs:
  containerize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349

      - name: Authenticate to Docker Hub
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567
        with:
          username: ${{ inputs.dockerhub-username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image (local only)
        run: |
          docker build -t "${{ inputs.dockerhub-username }}/${{ inputs.service-name }}:${{ github.run_id }}" .

      - name: Scan image in a private registry
        id: trivy-scan
        uses: aquasecurity/trivy-action@915b19bbe733ee0d458acc3d909c04390660a750
        with:
          image-ref: ${{ inputs.dockerhub-username }}/${{ inputs.service-name }}:${{ github.run_id }} 
          scan-type: image
          severity: 'CRITICAL'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          scanners: 'vuln,secret'

      - name: Push Docker images
        if: steps.trivy-scan.outcome == 'success'
        run: docker push "${{ inputs.dockerhub-username }}/${{ inputs.service-name }}:${{ github.run_id }}"

  update-k8s-manifest:
    runs-on: ubuntu-latest
    needs: containerize
    steps:
      - name: Checkout application code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Checkout K8s manifest repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: cloudhein/flextrack-microservices
          ref: main 
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }} 
          path: flextrack-repo 

      - name: Update Kubernetes manifest
        run: |
          # Dynamically update the image based on input variables
          sed -i "s|image: .*|image: ${{ inputs.dockerhub-username }}/${{ inputs.service-name }}:${{ github.run_id }}|g" flextrack-repo/flextrack-local-kind-eso/${{ inputs.manifest-file }}

      - name: Commit and push changes to K8s repo
        working-directory: flextrack-repo/flextrack-local-kind-eso
        run: |
          git config --local user.name "GitHub Actions Bot"
          git config --local user.email "actions@github.com"
          git add ${{ inputs.manifest-file }}
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "[CI] Update ${{ inputs.service-name }} image to ${{ github.run_id }} [skip ci]"
            git push origin main
          fi